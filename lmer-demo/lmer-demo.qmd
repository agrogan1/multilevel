---
title: "`lmer` Demo"
author: "Andy Grogan-Kaylor"
date: "today"
format:
  html: 
    toc: true
    number-sections: true
    code-fold: true
    code-summary: "Show the code"
    theme: yeti
    css: lmer-demo.css
    lightbox: true
bibliography: lmer-demo.bib
---

![Norway Spruce and Larch Forest in Austrian Alps, https://ec.europa.eu/jrc/en/research-topic/forestry/qr-tree-project/norway-spruce](fotolia-small.jpg)

# Get Data ðŸŒ²

Data are from *von Guttenberg's Norway spruce (Picea abies [L.] Karst) tree measurement data*, from @FAwR.

> "The data are measures from 107 trees. The trees were selected as being of average size from healthy and well stocked stands in the Alps."


```{r}
#| message: false

library(FAwR) # Forest Analytics with R

data("gutten") # Von Guttenberg Tree Data

```

```{r}
#| echo: false

library(haven) # write to Stata

gutten2 <- gutten # make a copy

colnames(gutten2)[4] <- "age_base"

colnames(gutten2)[6] <- "dbh_cm"

colnames(gutten2)[8] <- "age_bh"

colnames(gutten2)[9] <- "tree_ID"

write_dta(gutten2, "gutten.dta")

```

# Variables ðŸŒ²

`site` Growth *quality* class of the treeâ€™s habitat. 5 levels.

`location` Distinguishes tree *location*. 7 levels.

`tree` An identifier for the tree within location.

`age.base` The tree age taken at ground level.

`height` Tree height, m.

`dbh.cm` Tree diameter, cm.

`volume` Tree volume.

`age.bh` Tree age taken at 1.3 m.

`tree.ID` A factor uniquely identifying the tree.

# Data Wrangling (Centering) ðŸŒ²

```{r}

gutten$height.C <- gutten$height - mean(gutten$height)

gutten$age.base.C <- gutten$age.base - mean(gutten$age.base) 

```

# Graph ðŸŒ²

```{r}
#| message: false

library(ggplot2)

library(patchwork)

```


```{r}
#| fig-cap: "Tree Height by Tree Age"

p_uncentered <- ggplot(gutten,
                       aes(x = age.base,
                           y = height,
                           color = tree.ID)) +
  geom_line() +
  labs(title = "Tree Height By Tree Age",
       subtitle = "Uncentered Data") +
  scale_color_viridis_d() +
  theme_minimal() +
  theme(legend.position = "none")

# p_uncentered

p_centered <- ggplot(gutten,
                     aes(x = age.base.C,
                         y = height.C,
                         color = tree.ID)) +
  geom_line() +
  labs(title = "Tree Height By Tree Age",
       subtitle = "Centered Data") +
  scale_color_viridis_d() +
  theme_minimal() +
  theme(legend.position = "none")

# p_centered

p_uncentered + p_centered 

```

# `lmer` ðŸŒ²

```{r}
#| message: false

library(lme4) # MLM

library(sjPlot) # nice tables for MLM

```

## Unconditional Model ðŸŒ²

```{r}

fit0 <- lmer(height ~ (1 | tree.ID), 
             data = gutten)

tab_model(fit0)

```

## One Independent Variable; Random Intercept Only ðŸŒ²

```{r}

fit1 <- lmer(height ~ age.base + (1 | tree.ID), 
             data = gutten)

tab_model(fit1)

```

## One Independent Variable; Random Intercept and Random Slope (Correlated) ðŸŒ²

```{r}

fit2 <- lmer(height ~ age.base + (1 + age.base | tree.ID), 
             data = gutten)

tab_model(fit2)

```

## One Independent Variable; Random Intercept and Random Slope (Uncorrelated) ðŸŒ²

::: {.callout-important}
Converges only with *grand mean centered* independent variable.
:::

```{r}

fit3 <- lmer(height ~ age.base.C + (1 + age.base.C || tree.ID), 
             data = gutten)

tab_model(fit3)

```






