---
title: "Bayesian Longitudinal Multilevel Models"
author:
- name: Andy Grogan-Kaylor
  url: https://www.umich.edu/~agrogan
  affiliation: University of Michigan
  affiliation_url: https://www.umich.edu
date: "`r Sys.Date()`"
output:
  distill::distill_article:
    highlight: haddock
    toc: yes
    code_folding: true
  word_document:
    toc: yes
    reference_docx: "markstat.docx"
  pdf_document:
    toc: yes
    number_sections: yes
    highlight: haddock
    latex_engine: xelatex
description: |
  Using brms / STAN
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, 
                      message = FALSE,
                      warning = FALSE)

```

# Set Up ðŸŒ²

You will need to install the relevant packages: `lme4` for frequentist MLM, and `brms`, which also installs `STAN`, for Bayesian MLM.

```{r, eval=FALSE}

install.packages(c("lme4", "brms"))

```

# Gutten Tree Data ðŸŒ²

![Norway Spruce and Larch Forest in Austrian Alps, <https://ec.europa.eu/jrc/en/research-topic/forestry/qr-tree-project/norway-spruce>](fotolia-small.jpg)

The data used in this example are derived from the R package *Functions and Datasets for "Forest Analytics with R"*.

According to the documentation, the source of these data are: "von Guttenberg's Norway spruce (Picea abies [L.] Karst) tree measurement data."

The documentation goes on to further note that:

> "The data are measures from 107 trees. The trees were selected as being of average size from healthy and well stocked stands in the Alps."

# Import The Data ðŸŒ²

```{r}

library(haven)

gutten <- read_dta("gutten.dta")

gutten 

```

# Variables ðŸŒ²

`site` Growth *quality* class of the tree's habitat. 5 levels.

`location` Distinguishes tree *location*. 7 levels.

`tree` An identifier for the tree within location.

`age.base` The tree age taken at ground level.

`height` Tree height, m.

`dbh.cm` Tree diameter, cm.

`volume` Tree volume.

`age.bh` Tree age taken at 1.3 m.

`tree.ID` A factor uniquely identifying the tree.

# A Basic Multilevel Model ðŸŒ²

$$\text{height}_{it} = \beta_0 + \beta \text{age_base} + \beta \text{site} + \beta \text{age_base * site} + u_{0\text{ tree.ID}} + e_{it}$$ Both `lmer` (frequentist MLM) and `brms` (Bayesian MLM) use the idea of translating the above equation into a *formula*:

`height ~ age_base + site + (1 | tree_ID)`

# Graph (Spaghetti Plot)

```{r}

library(ggplot2)

ggplot(gutten,
       aes(x = age_base, # x is tree age
           y = height)) + # y is tree height
  geom_smooth(aes(color = as.factor(tree_ID)), 
              method = "lm",
              se = FALSE) + # linear model for each tree
  geom_smooth(method = "lm", 
              color = "red",
              size = 2) + # linear model 
  labs(title = "Tree Height As A Function Of Age") +
  theme_minimal() +
  theme(legend.position = "none")

```

# Frequentist Model in `lmer` ðŸŒ²

> NB: `*` provides with an interaction term and main effects.
 
```{r}

library(lme4)

fit1 <- lmer(height ~ age_base * site + (1 | tree_ID), 
             data = gutten)

summary(fit1)

```

# Bayesian Model With `brms` (Less Informative Default Priors) ðŸŒ²

> The models below take a non-trivial amount of time to run.

```{r}

library(brms)

fit2 <- brm(height ~ age_base * site + (1 | tree_ID), 
            data = gutten,
            family = gaussian(), 
            warmup = 2000, 
            iter = 5000)

summary(fit2)

```

# Set Informative Priors ðŸŒ²

```{r}

prior1 <- c(
  prior(normal(0, 10), class = Intercept), 
  prior(normal(0, 10), class = b, coef = site) #,
  # prior(cauchy(0, 10), class = sigma)
)

```

# Run The Model With More Informative Prior ðŸŒ²

```{r}

fit3 <- brm(height ~ age_base * site + (1 | tree_ID), 
            data = gutten,
            family = gaussian(), 
            prior = prior1,
            warmup = 2000, 
            iter = 5000)

summary(fit3)

```

# Plot Posterior Distributions and Trace Plots ðŸŒ²

> `plot(fit3)` will give me a reasonable plot of *every* parameter, but the layout may not be optimal. I am using separate plot calls below, but to do so, I need to know the *names* of the parameters, which can be tricky in `brms`. One way to do this is to use `plot(fit3)` to see all the parameter names, and then divide the single `plot` call into multiple `plot` calls to improve the layout.

```{r}

# plot(fit3)

plot(fit3, variable = c("b_Intercept"))

plot(fit3, 
     variable = c("b_age_base", 
                  "b_site",
                  "b_age_base:site")) # regression slopes

plot(fit3, variable = c("sd_tree_ID__Intercept",
                        "sigma")) # variance parameters

```

